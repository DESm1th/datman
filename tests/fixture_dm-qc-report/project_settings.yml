STUDYNAME: STUDY1                           # Data archive study name
MRUSER: USER_NAME                               # MR Unit FTP user
PREFIX: STUDY                              # Prefix of filenames
PROJECTDIR: '${DATMAN_PROJECTSDIR}/STUDY1'  # Directory inside data-2.0
# The STUDY_ID tag that should be used to identify the study, site specific
# tags can be added to a SITE_IDS: [] key under the specific site
STUDY_ID: STUDY
FullName: Text here
Description: Description here
PrimaryContact: PI name here

paths:
  meta: './STUDY1/metadata'
  dcm:  './STUDY1/data/dcm'
  nii:  './STUDY1/data/nii'
  mnc:  './STUDY1/data/mnc'
  nrrd: './STUDY1/data/nrrd'
  resources: './STUDY1/data/RESOURCES'
  qc:   './STUDY1/qc'
  std:  './STUDY1/metadata/standards'
  log:  './STUDY1/logs'
  fmri: './STUDY1/pipelines/fmri'
  hcp:  './STUDY1/pipelines/hcp'

Sites:
   CMH:
      SITE_IDS: ['STUDY']
      XNAT_Archive: './xnat/STUDY1/arc001'
      ExportInfo:
         T1:         { Pattern: ['T1','BRAVO'],      Count: 1}
         FMAP-6.5:   { Pattern: ['TE6.5','TE65'],    Count: 2}
         FMAP-8.5:   { Pattern: ['TE8.5','TE85'],    Count: 2}
         RST:        { Pattern: ['Resting', 'Rest'], Count: 1}
         OBS:        { Pattern: 'Observ',            Count: 1}
         IMI:        { Pattern: 'Imitat',            Count: 1}
         EMP:        { Pattern: 'EA',                Count: 3}
         DTI60-1000: { Pattern: ['DTI.60'],          Count: 1}
         PDT2:       { Pattern: ['T2.DE', 'T2DE'],   Count: 1}
         FLAIR:      { Pattern: 'FLAIR',             Count: 1}

   MRP:
      XNAT_Archive: './xnat/STUDY1/arc001'
      ExportInfo:
           T1:         { Pattern: ['MPRAGE'],            Count: 3 }
           RST:        { Pattern: ['Resting'],           Count: 1 }
           OBS:        { Pattern: 'Observ',              Count: 1 }
           IMI:        { Pattern: 'Imitat',              Count: 1 }
           EMP:        { Pattern: 'EA',                  Count: 3 }
           DTI60-1000: { Pattern: ['DTI.60Dir.5B0$',
                         'DTI.60Dir.5B0*fBIRN*TR-2$',
                         'DTI.60Dir.5B0*fBIRN*TE84ms$'], Count: 1 }
           FMAP-6.5:   { Pattern: '6.5ms',               Count: 2 }
           FMAP-8.5:   { Pattern: '8.5ms',               Count: 1 }
           PDT2:       { Pattern: 'TSE',                 Count: 1 }
           FLAIR:      { Pattern: 'FLAIR',               Count: 1 }

fmri:
    imob:
        export: ['filtered', 'MNI-nonlin']
        pipeline: 'task.sh'
        tags: ['IMI', 'OBS']
        del: 4
        tr: 3
        dims: 3
        conn: ['MNI-nonlin']
        glm: ['MNI-nonlin']
    ea:
        export: ['filtered', 'MNI-nonlin']
        pipeline: 'task.sh'
        tags: 'EMP'
        del: 4
        tr: 2
        dims: 3.4
        conn: ['MNI-nonlin']
        glm: ['MNI-nonlin']
    rest:
        export: ['filtered', 'MNI-nonlin']
        pipeline: 'rest.sh'
        tags: 'RST'
        del: 4
        tr: 2
        dims: 3.125
        conn: ['MNI-nonlin']

PipelineSettings:
  - 'dm-proc-CIVET.py' :
      message: 'Running CIVET'
      runif: "'T1' in ScanTypes"
      arguments:
       - '--QCed-transfer ${PROJECTDIR}/metadata/checklist.csv '
       - '${PROJECTDIR}/data/mnc/'
       - '${PROJECTDIR}/data/civet/'
       - 'STUDY1'

  - 'dm-proc-dtifit.py' :
      message: 'Running dtifit'
      dependancies: 'FSL'
      CallMultipleTimes:
        MRC :
          arguments:
            - '--tag "MRC"'
            - '--fa_thresh "0.15"'
            - '--inputdir ${PROJECTDIR}/data/nii'
            - '--outputdir ${PROJECTDIR}/pipelines/dtifit'
        ZHH:
          arguments:
            - '--tag "ZHH"'
            - '--inputdir ${PROJECTDIR}/data/nii'
            - '--outputdir ${PROJECTDIR}/pipelines/dtifit'
        CMH:
          arguments:
            - '--tag "CMH"'
            - '--inputdir ${PROJECTDIR}/data/nii'
            - '--outputdir ${PROJECTDIR}/pipelines/dtifit'

  - 'dtifit-qc.py' :
      message: 'Running ditfit qc'
      runif: 'any("DTI" in s for s in ScanTypes)'
      arguments:
        - '${PROJECTDIR}/pipelines/dtifit/'
      dependancies: FSL

  - 'dm-proc-enigmadti.py' :
      message: 'Running enignmaDTI'
      arguments:
        - '--calc-all'
        - '--tag2 DTI60'
        - '--QC-transfer ${PROJECTDIR}/metadata/checklist.csv'
        - '${PROJECTDIR}/pipelines/dtifit'
        - '${PROJECTDIR}/pipelines/enigmaDTI'
      dependancies: [FSL, R, ENIGMA-DTI]

  - 'dm-proc-freesurfer.py' :
        message: 'Running freesurfer'
        dependancies: [freesurfer, AFNI, FSL, datman]
        environment: 'export SUBJECTS_DIR=${PROJECTDIR}/pipelines/freesurfer'
        CallMultipleTimes :
          CMH:
            arguments:
              - '--no-postFS'
              - '--tag2 CMH'
              - '--run-version CMH'
              - '--QC-transfer ${PROJECTDIR}/metadata/checklist.csv'
              - '${PROJECTDIR}/data/nii/'
              - '${PROJECTDIR}/pipelines/freesurfer/'
          ZHH:
            arguments:
              - '--no-postFS'
              - '--tag2 ZHH'
              - '--run-version ZHH'
              - '--QC-transfer ${PROJECTDIR}/metadata/checklist.csv'
              - '${PROJECTDIR}/data/nii/'
              - '${PROJECTDIR}/pipelines/freesurfer/'
          MRC:
            arguments:
              - '--tag2 MRC'
              - '--run-version MRC'
              - '--multiple-inputs'
              - "--FS-option '-nuiterations 8'"
              - '--QC-transfer ${PROJECTDIR}/metadata/checklist.csv'
              - '${PROJECTDIR}/data/nii/'
              - '${PROJECTDIR}/pipelines/freesurfer/'
        Reason: >
            The aquisition at the MRC site is different from those at the other sites.
            Instead of collecting 1 high resolution T1 image, they collect 3 low res images which we need to input together.
            For this reason, we need site specific freesurfer settings for the MRC site.
            We use the flag "--multiple-inputs" to say that multiple files should be inputed to freesurfer (instead of 1).
            We also changed the freesurfer options to add "-nuiterations 8". Which means that nu_correct is run 8 times (instead of 2x). Because 2 times was not enough.
